<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Ratings</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 1px solid #222;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #888;
            font-size: 1rem;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            color: #888;
            font-size: 0.9rem;
        }

        select, input[type="text"] {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus, input[type="text"]:focus {
            border-color: #667eea;
        }

        input[type="text"] {
            width: 200px;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            margin: 20px 0;
            padding: 20px;
            background: #111;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #222;
        }

        th {
            background: #111;
            color: #888;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }

        th:hover {
            color: #667eea;
        }

        th.sorted-asc::after {
            content: ' ▲';
        }

        th.sorted-desc::after {
            content: ' ▼';
        }

        tr:hover {
            background: #151515;
        }

        .rank {
            font-weight: 700;
            color: #667eea;
            width: 60px;
        }

        .team {
            font-weight: 600;
        }

        .rating {
            font-weight: 700;
            color: #4ade80;
        }

        .rating.negative {
            color: #f87171;
        }

        .number {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            color: #999;
        }

        .spread-calculator {
            background: #111;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .spread-calculator h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #888;
        }

        .spread-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .spread-inputs .control-group {
            flex-direction: column;
            align-items: flex-start;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .spread-result {
            margin-top: 20px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 8px;
            display: none;
        }

        .spread-result.visible {
            display: block;
        }

        .spread-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
        }

        .spread-details {
            margin-top: 10px;
            color: #888;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            color: #888;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: #667eea;
            color: #e0e0e0;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: #444;
            font-size: 0.85rem;
            border-top: 1px solid #222;
            margin-top: 40px;
        }

        .efficiency-grid {
            background: #111;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .efficiency-grid h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #888;
        }

        .chart-container {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .chart-controls {
            margin-bottom: 15px;
        }

        .toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #888;
            font-size: 0.9rem;
        }

        .toggle-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #power-teams-toggle {
            display: none;
        }

        .show-power-toggle #power-teams-toggle {
            display: inline-flex;
        }

        /* Team History Modal */
        .team-link {
            cursor: pointer;
            transition: color 0.2s;
        }

        .team-link:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: #111;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #e0e0e0;
            background: none;
            transform: none;
            box-shadow: none;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .modal-header img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #e0e0e0;
        }

        .modal-header .team-meta {
            color: #888;
            font-size: 0.9rem;
        }

        .history-chart-container {
            position: relative;
            max-width: 100%;
            margin-bottom: 25px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-table th, .history-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #222;
        }

        .history-table th {
            position: static;
            background: #1a1a1a;
        }

        .modal-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .hide-mobile {
                display: none;
            }

            .modal {
                padding: 20px 15px;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Power Ratings</h1>
        <p class="subtitle">Opponent-adjusted efficiency ratings for college basketball</p>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-sport="cbb">College Basketball</div>
            <div class="tab" data-sport="cfb">College Football</div>
            <div class="tab" data-sport="nfl">NFL</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="season">Season:</label>
                <select id="season">
                    <option value="2026">2025-26</option>
                </select>
            </div>
            <div class="control-group">
                <label for="search">Search:</label>
                <input type="text" id="search" placeholder="Team name...">
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="stat-teams">-</div>
                <div class="stat-label">Teams</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-top-rating">-</div>
                <div class="stat-label">Top Rating</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-avg-tempo">-</div>
                <div class="stat-label">Avg Tempo</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-last-updated">-</div>
                <div class="stat-label">Last Updated</div>
            </div>
        </div>

        <div class="spread-calculator">
            <h2>Spread Calculator</h2>
            <div class="spread-inputs">
                <div class="control-group">
                    <label for="team-a">Team A:</label>
                    <input type="text" id="team-a" placeholder="e.g. Duke">
                </div>
                <div class="control-group">
                    <label for="team-b">Team B:</label>
                    <input type="text" id="team-b" placeholder="e.g. North Carolina">
                </div>
                <div class="control-group">
                    <label for="home-team">Home Team:</label>
                    <select id="home-team">
                        <option value="">Neutral</option>
                        <option value="a">Team A</option>
                        <option value="b">Team B</option>
                    </select>
                </div>
                <button onclick="calculateSpread()">Calculate</button>
            </div>
            <div class="spread-result" id="spread-result">
                <div class="spread-value" id="spread-value"></div>
                <div class="spread-details" id="spread-details"></div>
            </div>
        </div>

        <div class="efficiency-grid">
            <h2>Efficiency Grid</h2>
            <div class="chart-controls">
                <label class="toggle-label" id="power-teams-toggle">
                    <input type="checkbox" id="power-teams-only" checked>
                    <span>Power Teams Only (Top 50)</span>
                </label>
            </div>
            <div class="chart-container">
                <canvas id="efficiency-chart"></canvas>
            </div>
        </div>

        <div id="ratings-container">
            <div class="loading">Loading ratings...</div>
        </div>

        <!-- Team History Modal -->
        <div class="modal-overlay" id="team-history-modal">
            <div class="modal">
                <button class="modal-close" id="modal-close">&times;</button>
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <footer>
        Power Ratings | Opponent-adjusted efficiency per 100 possessions
    </footer>

    <script>
        let allRatings = [];
        let currentSort = { column: 'rank', direction: 'asc' };
        let currentSport = 'cbb';
        let historyChart = null;
        const allSeasonsCache = { cbb: null, cfb: null, nfl: null };

        function getDataPath() {
            return currentSport === 'cbb' ? 'data' : `data/${currentSport}`;
        }

        async function loadSeasons() {
            try {
                const pathMap = { cbb: 'data/seasons.json', cfb: 'data/cfb/seasons.json', nfl: 'data/nfl/seasons.json' };
                const basePath = pathMap[currentSport];
                const response = await fetch(basePath);
                const data = await response.json();
                const select = document.getElementById('season');
                // NFL and CFB use start-year naming (2024 = 2024-25 season)
                // CBB uses end-year naming (2025 = 2024-25 season)
                if (currentSport === 'cbb') {
                    select.innerHTML = data.seasons.map(s =>
                        `<option value="${s}">${s-1}-${String(s).slice(2)}</option>`
                    ).join('');
                } else {
                    // NFL and CFB both use start-year
                    select.innerHTML = data.seasons.map(s =>
                        `<option value="${s}">${s}-${String(s+1).slice(2)}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('Failed to load seasons:', e);
            }
        }

        async function loadRatings() {
            const season = document.getElementById('season').value;
            const container = document.getElementById('ratings-container');

            container.innerHTML = '<div class="loading">Loading ratings...</div>';

            try {
                const pathMap = { cbb: 'data', cfb: 'data/cfb', nfl: 'data/nfl' };
                const basePath = pathMap[currentSport];
                const response = await fetch(`${basePath}/ratings_${season}.json`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div class="loading">${data.error}</div>`;
                    return;
                }

                allRatings = data.ratings;
                updateStats(allRatings, data.lastUpdated);
                renderTable(allRatings);
                renderEfficiencyChart(allRatings);
            } catch (e) {
                container.innerHTML = '<div class="loading">Failed to load ratings</div>';
                console.error(e);
            }
        }

        function switchSport(sport) {
            currentSport = sport;
            closeModal();
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-sport="${sport}"]`).classList.add('active');

            // Update subtitle
            const subtitle = document.querySelector('.subtitle');
            if (sport === 'cbb') {
                subtitle.textContent = 'Opponent-adjusted efficiency ratings for college basketball';
            } else if (sport === 'cfb') {
                subtitle.textContent = 'Opponent-adjusted efficiency ratings for college football';
            } else if (sport === 'nfl') {
                subtitle.textContent = 'Opponent-adjusted EPA and success rate ratings';
            }

            loadSeasons().then(loadRatings);
        }

        function updateStats(ratings, lastUpdated) {
            document.getElementById('stat-teams').textContent = ratings.length;
            if (ratings.length > 0) {
                document.getElementById('stat-top-rating').textContent = ratings[0].rating.toFixed(1);
                const avgTempo = ratings.reduce((sum, r) => sum + (r.tempo || 0), 0) / ratings.length;
                document.getElementById('stat-avg-tempo').textContent = avgTempo.toFixed(1);
            }
            document.getElementById('stat-last-updated').textContent = lastUpdated || '-';
        }

        function renderTable(ratings) {
            const container = document.getElementById('ratings-container');

            if (ratings.length === 0) {
                container.innerHTML = '<div class="loading">No teams found</div>';
                return;
            }

            let headers, rowsHtml;

            if (currentSport === 'nfl') {
                headers = [
                    { key: 'rank', label: 'Rank' },
                    { key: 'team', label: 'Team' },
                    { key: 'rating', label: 'Rating' },
                    { key: 'record', label: 'Record' },
                    { key: 'adjOffEpa', label: 'Adj Off EPA' },
                    { key: 'adjDefEpa', label: 'Adj Def EPA' },
                    { key: 'adjOffSuccess', label: 'Adj Off SR%', hideOnMobile: true },
                    { key: 'adjDefSuccess', label: 'Adj Def SR%', hideOnMobile: true },
                    { key: 'rawOffEpa', label: 'Raw Off EPA', hideOnMobile: true },
                    { key: 'rawDefEpa', label: 'Raw Def EPA', hideOnMobile: true }
                ];
                rowsHtml = ratings.map(r => {
                    const ratingClass = r.rating >= 0 ? 'rating' : 'rating negative';
                    return `
                        <tr>
                            <td class="rank">${r.rank}</td>
                            <td class="team team-link" data-team="${r.team}" data-team-id="">${r.team}</td>
                            <td class="${ratingClass}">${r.rating?.toFixed(1) || '-'}</td>
                            <td class="number">${r.record || '-'}</td>
                            <td class="number">${r.adjOffEpa?.toFixed(3) || '-'}</td>
                            <td class="number">${r.adjDefEpa?.toFixed(3) || '-'}</td>
                            <td class="number hide-mobile">${r.adjOffSuccess ? (r.adjOffSuccess * 100).toFixed(1) + '%' : '-'}</td>
                            <td class="number hide-mobile">${r.adjDefSuccess ? (r.adjDefSuccess * 100).toFixed(1) + '%' : '-'}</td>
                            <td class="number hide-mobile">${r.rawOffEpa?.toFixed(3) || '-'}</td>
                            <td class="number hide-mobile">${r.rawDefEpa?.toFixed(3) || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                headers = [
                    { key: 'rank', label: 'Rank' },
                    { key: 'team', label: 'Team' },
                    { key: 'rating', label: 'Rating' },
                    { key: 'record', label: 'Record' },
                    { key: 'adjO', label: 'AdjO' },
                    { key: 'adjD', label: 'AdjD' },
                    { key: 'tempo', label: 'Tempo', hideOnMobile: true },
                    { key: 'sos', label: 'SOS', hideOnMobile: true }
                ];
                rowsHtml = ratings.map(r => {
                    const ratingClass = r.rating >= 0 ? 'rating' : 'rating negative';
                    return `
                        <tr>
                            <td class="rank">${r.rank}</td>
                            <td class="team team-link" data-team="${r.team}" data-team-id="${r.teamId || ''}">${r.team}</td>
                            <td class="${ratingClass}">${r.rating?.toFixed(2) || '-'}</td>
                            <td class="number">${r.record || '-'}</td>
                            <td class="number">${r.adjO?.toFixed(1) || '-'}</td>
                            <td class="number">${r.adjD?.toFixed(1) || '-'}</td>
                            <td class="number hide-mobile">${r.tempo?.toFixed(1) || '-'}</td>
                            <td class="number hide-mobile">${r.sos?.toFixed(2) || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }

            const headerHtml = headers.map(h => {
                const sortClass = currentSort.column === h.key
                    ? `sorted-${currentSort.direction}`
                    : '';
                const mobileClass = h.hideOnMobile ? 'hide-mobile' : '';
                return `<th class="${sortClass} ${mobileClass}" data-column="${h.key}">${h.label}</th>`;
            }).join('');

            container.innerHTML = `
                <table>
                    <thead><tr>${headerHtml}</tr></thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            `;

            // Add sort listeners
            container.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.column));
            });

            // Add team click listeners for history modal
            container.querySelectorAll('.team-link').forEach(td => {
                td.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showTeamHistory(td.dataset.team, td.dataset.teamId || null);
                });
            });
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'rank' ? 'asc' : 'desc';
            }

            const sorted = [...allRatings].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(sorted);
        }

        function filterRatings() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allRatings.filter(r =>
                r.team.toLowerCase().includes(search)
            );
            renderTable(filtered);
        }

        function calculateSpread() {
            const teamAInput = document.getElementById('team-a').value.toLowerCase().trim();
            const teamBInput = document.getElementById('team-b').value.toLowerCase().trim();
            const home = document.getElementById('home-team').value;

            if (!teamAInput || !teamBInput) {
                alert('Please enter both team names');
                return;
            }

            const resultDiv = document.getElementById('spread-result');
            const valueDiv = document.getElementById('spread-value');
            const detailsDiv = document.getElementById('spread-details');

            // Find teams by partial match
            const teamA = allRatings.find(r => r.team.toLowerCase().includes(teamAInput));
            const teamB = allRatings.find(r => r.team.toLowerCase().includes(teamBInput));

            if (!teamA) {
                valueDiv.textContent = 'Error';
                detailsDiv.textContent = `Team not found: "${document.getElementById('team-a').value}"`;
                resultDiv.classList.add('visible');
                return;
            }
            if (!teamB) {
                valueDiv.textContent = 'Error';
                detailsDiv.textContent = `Team not found: "${document.getElementById('team-b').value}"`;
                resultDiv.classList.add('visible');
                return;
            }

            const HOME_COURT_ADVANTAGE = 3.5;
            const tempoA = teamA.tempo || 70.0;
            const tempoB = teamB.tempo || 70.0;
            const nationalAvgTempo = allRatings.reduce((sum, r) => sum + (r.tempo || 70), 0) / allRatings.length;
            const expectedTempo = (tempoA * tempoB) / nationalAvgTempo;

            let spread = (teamA.rating - teamB.rating) * (expectedTempo / 100);
            if (home === 'a') spread += HOME_COURT_ADVANTAGE;
            else if (home === 'b') spread -= HOME_COURT_ADVANTAGE;

            const favorite = spread > 0 ? teamA.team : teamB.team;
            const spreadStr = Math.abs(spread).toFixed(1);
            const venueLabel = !home ? 'Neutral' : home === 'a' ? teamA.team + ' home' : teamB.team + ' home';

            valueDiv.textContent = spread === 0 ? "Pick'em" : `${favorite} -${spreadStr}`;
            detailsDiv.innerHTML = `
                ${teamA.team}: ${teamA.rating.toFixed(2)} | ${teamB.team}: ${teamB.rating.toFixed(2)}<br>
                Expected tempo: ${expectedTempo.toFixed(1)} | Venue: ${venueLabel}
            `;
            resultDiv.classList.add('visible');
        }

        let efficiencyChart = null;
        const logoCache = {};

        // ESPN team ID mapping for CFB teams
        const cfbTeamIds = {
            'Alabama': 333, 'Arizona': 12, 'Arizona State': 9, 'Arkansas': 8, 'Auburn': 2,
            'Baylor': 239, 'Boston College': 103, 'BYU': 252, 'California': 25, 'Cincinnati': 2132,
            'Clemson': 228, 'Colorado': 38, 'Duke': 150, 'Florida': 57, 'Florida State': 52,
            'Georgia': 61, 'Georgia Tech': 59, 'Houston': 248, 'Illinois': 356, 'Indiana': 84,
            'Iowa': 2294, 'Iowa State': 66, 'Kansas': 2305, 'Kansas State': 2306, 'Kentucky': 96,
            'Louisville': 97, 'LSU': 99, 'Maryland': 120, 'Miami': 2390, 'Michigan': 130,
            'Michigan State': 127, 'Minnesota': 135, 'Mississippi State': 344, 'Missouri': 142,
            'Nebraska': 158, 'North Carolina': 153, 'NC State': 152, 'Northwestern': 77,
            'Notre Dame': 87, 'Ohio State': 194, 'Oklahoma': 201, 'Oklahoma State': 197,
            'Ole Miss': 145, 'Oregon': 2483, 'Oregon State': 204, 'Penn State': 213,
            'Pittsburgh': 221, 'Purdue': 2509, 'Rutgers': 164, 'SMU': 2567, 'South Carolina': 2579,
            'Stanford': 24, 'Syracuse': 183, 'TCU': 2628, 'Tennessee': 2633, 'Texas': 251,
            'Texas A&M': 245, 'Texas Tech': 2641, 'UCF': 2116, 'UCLA': 26, 'USC': 30,
            'Utah': 254, 'Vanderbilt': 238, 'Virginia': 258, 'Virginia Tech': 259,
            'Wake Forest': 154, 'Washington': 264, 'Washington State': 265, 'West Virginia': 277,
            'Wisconsin': 275, 'Memphis': 235, 'Tulane': 2655, 'Navy': 2426, 'Army': 349,
            'Air Force': 2005, 'Boise State': 68, 'San Diego State': 21, 'Fresno State': 278,
            'Colorado State': 36, 'UNLV': 2439, 'Nevada': 2440, 'Wyoming': 2704, 'Hawaii': 62,
            'San Jose State': 23, 'Utah State': 328, 'New Mexico': 167, 'Coastal Carolina': 324,
            'Appalachian State': 2026, 'James Madison': 256, 'Liberty': 2335, 'Marshall': 276,
            'Jacksonville State': 55, 'Sam Houston': 2534, 'UTSA': 2636, 'North Texas': 249,
            'Rice': 242, 'Tulsa': 202, 'East Carolina': 151, 'Charlotte': 2429, 'FAU': 2226,
            'Temple': 218, 'UAB': 5, 'South Florida': 58, 'Buffalo': 2084, 'Miami (OH)': 193,
            'Ohio': 195, 'Bowling Green': 189, 'Toledo': 2649, 'Western Michigan': 2711,
            'Central Michigan': 2117, 'Eastern Michigan': 2199, 'Akron': 2006, 'Kent State': 2309,
            'Ball State': 2050, 'Northern Illinois': 2459, 'Troy': 2653, 'South Alabama': 6,
            'Louisiana': 309, 'Arkansas State': 2032, 'Texas State': 326, 'Georgia State': 2247,
            'Georgia Southern': 290, 'Old Dominion': 295, 'UConn': 41, 'UMass': 113,
            'New Mexico State': 166, 'Kennesaw State': 338, 'UTEP': 2638, 'Louisiana Tech': 2348,
            'Middle Tennessee': 2393, 'FIU': 2229, 'Western Kentucky': 98, 'Southern Miss': 2572,
            // Alternative spellings
            'Hawai\'i': 62, 'Hawaii': 62, 'San José State': 23, 'Florida Atlantic': 2226,
            'Florida International': 2229, 'App State': 2026, 'UL Monroe': 2433,
            'Massachusetts': 113, 'UMass': 113
        };

        // Power conference teams for CFB (Power 4: SEC, Big Ten, Big 12, ACC)
        const cfbPowerTeams = new Set([
            // SEC
            'Alabama', 'Arkansas', 'Auburn', 'Florida', 'Georgia', 'Kentucky', 'LSU',
            'Mississippi State', 'Missouri', 'Oklahoma', 'Ole Miss', 'South Carolina',
            'Tennessee', 'Texas', 'Texas A&M', 'Vanderbilt',
            // Big Ten
            'Illinois', 'Indiana', 'Iowa', 'Maryland', 'Michigan', 'Michigan State',
            'Minnesota', 'Nebraska', 'Northwestern', 'Ohio State', 'Oregon', 'Penn State',
            'Purdue', 'Rutgers', 'UCLA', 'USC', 'Washington', 'Wisconsin',
            // Big 12
            'Arizona', 'Arizona State', 'Baylor', 'BYU', 'Cincinnati', 'Colorado',
            'Houston', 'Iowa State', 'Kansas', 'Kansas State', 'Oklahoma State', 'TCU',
            'Texas Tech', 'UCF', 'Utah', 'West Virginia',
            // ACC
            'Boston College', 'California', 'Clemson', 'Duke', 'Florida State', 'Georgia Tech',
            'Louisville', 'Miami', 'NC State', 'North Carolina', 'Pittsburgh', 'SMU',
            'Stanford', 'Syracuse', 'Virginia', 'Virginia Tech', 'Wake Forest',
            // Notre Dame (independent but power)
            'Notre Dame'
        ]);

        // Power conference teams for CBB (Power 6: SEC, Big Ten, Big 12, ACC, Big East, Pac-12 remnants)
        const cbbPowerTeams = new Set([
            // SEC
            'Alabama Crimson Tide', 'Arkansas Razorbacks', 'Auburn Tigers', 'Florida Gators',
            'Georgia Bulldogs', 'Kentucky Wildcats', 'LSU Tigers', 'Mississippi State Bulldogs',
            'Missouri Tigers', 'Oklahoma Sooners', 'Ole Miss Rebels', 'South Carolina Gamecocks',
            'Tennessee Volunteers', 'Texas Longhorns', 'Texas A&M Aggies', 'Vanderbilt Commodores',
            // Big Ten
            'Illinois Fighting Illini', 'Indiana Hoosiers', 'Iowa Hawkeyes', 'Maryland Terrapins',
            'Michigan Wolverines', 'Michigan State Spartans', 'Minnesota Golden Gophers',
            'Nebraska Cornhuskers', 'Northwestern Wildcats', 'Ohio State Buckeyes', 'Oregon Ducks',
            'Penn State Nittany Lions', 'Purdue Boilermakers', 'Rutgers Scarlet Knights',
            'UCLA Bruins', 'USC Trojans', 'Washington Huskies', 'Wisconsin Badgers',
            // Big 12
            'Arizona Wildcats', 'Arizona State Sun Devils', 'Baylor Bears', 'BYU Cougars',
            'Cincinnati Bearcats', 'Colorado Buffaloes', 'Houston Cougars', 'Iowa State Cyclones',
            'Kansas Jayhawks', 'Kansas State Wildcats', 'Oklahoma State Cowboys', 'TCU Horned Frogs',
            'Texas Tech Red Raiders', 'UCF Knights', 'Utah Utes', 'West Virginia Mountaineers',
            // ACC
            'Boston College Eagles', 'California Golden Bears', 'Clemson Tigers', 'Duke Blue Devils',
            'Florida State Seminoles', 'Georgia Tech Yellow Jackets', 'Louisville Cardinals',
            'Miami Hurricanes', 'NC State Wolfpack', 'North Carolina Tar Heels', 'Pittsburgh Panthers',
            'SMU Mustangs', 'Stanford Cardinal', 'Syracuse Orange', 'Virginia Cavaliers',
            'Virginia Tech Hokies', 'Wake Forest Demon Deacons', 'Notre Dame Fighting Irish',
            // Big East
            'Butler Bulldogs', 'Creighton Bluejays', 'DePaul Blue Demons', 'Georgetown Hoyas',
            'Marquette Golden Eagles', 'Providence Friars', 'Seton Hall Pirates', 'St. John\'s Red Storm',
            'UConn Huskies', 'Villanova Wildcats', 'Xavier Musketeers'
        ]);

        function isPowerTeam(team) {
            if (currentSport === 'cfb') {
                return cfbPowerTeams.has(team.team);
            } else if (currentSport === 'cbb') {
                return cbbPowerTeams.has(team.team);
            }
            return false;
        }

        function getLogoUrl(team) {
            if (currentSport === 'nfl') {
                return `https://a.espncdn.com/i/teamlogos/nfl/500/${team.team.toLowerCase()}.png`;
            } else if (currentSport === 'cbb' && team.teamId) {
                return `https://a.espncdn.com/i/teamlogos/ncaa/500/${team.teamId}.png`;
            } else if (currentSport === 'cfb') {
                const espnId = cfbTeamIds[team.team];
                if (espnId) {
                    return `https://a.espncdn.com/i/teamlogos/ncaa/500/${espnId}.png`;
                }
            }
            return null;
        }

        function loadImage(url) {
            return new Promise((resolve) => {
                if (logoCache[url]) {
                    resolve(logoCache[url]);
                    return;
                }
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    logoCache[url] = img;
                    resolve(img);
                };
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }

        async function renderEfficiencyChart(ratings) {
            const ctx = document.getElementById('efficiency-chart').getContext('2d');

            // Destroy existing chart if any
            if (efficiencyChart) {
                efficiencyChart.destroy();
            }

            // Show/hide power teams toggle (not needed for NFL - only 32 teams)
            const gridContainer = document.querySelector('.efficiency-grid');
            if (currentSport === 'nfl') {
                gridContainer.classList.remove('show-power-toggle');
            } else {
                gridContainer.classList.add('show-power-toggle');
            }

            // Filter to power teams if toggle is checked
            const powerTeamsOnly = document.getElementById('power-teams-only').checked;
            let filteredRatings = ratings;
            if (currentSport !== 'nfl' && powerTeamsOnly) {
                if (currentSport === 'cfb') {
                    // CFB: only power conference teams (SEC, Big Ten, Big 12, ACC + Notre Dame)
                    filteredRatings = ratings.filter(t => isPowerTeam(t));
                } else {
                    // CBB: power conference teams OR top 50
                    filteredRatings = ratings.filter(t => isPowerTeam(t) || t.rank <= 50);
                }
            }

            // Get the right fields based on sport
            let xField, yField, xLabel, yLabel;
            if (currentSport === 'nfl') {
                xField = 'adjOffEpa';
                yField = 'adjDefEpa';
                xLabel = 'Adjusted Offensive EPA';
                yLabel = 'Adjusted Defensive EPA (lower is better)';
            } else {
                xField = 'adjO';
                yField = 'adjD';
                xLabel = 'Adjusted Offensive Efficiency';
                yLabel = 'Adjusted Defensive Efficiency (lower is better)';
            }

            // Preload logos
            const logoPromises = filteredRatings.map(async (team) => {
                const url = getLogoUrl(team);
                if (url) {
                    return { team: team.team, img: await loadImage(url) };
                }
                return { team: team.team, img: null };
            });
            const logos = await Promise.all(logoPromises);
            const logoMap = {};
            logos.forEach(l => { logoMap[l.team] = l.img; });

            // Create data points
            const dataPoints = filteredRatings.map((team) => {
                return {
                    x: team[xField],
                    y: team[yField],
                    team: team.team,
                    teamId: team.teamId,
                    rating: team.rating,
                    rank: team.rank,
                    logo: logoMap[team.team]
                };
            }).filter(d => d.x != null && d.y != null);

            // Calculate medians for reference lines
            const xValues = dataPoints.map(d => d.x).sort((a, b) => a - b);
            const yValues = dataPoints.map(d => d.y).sort((a, b) => a - b);
            const median = arr => {
                const mid = Math.floor(arr.length / 2);
                return arr.length % 2 ? arr[mid] : (arr[mid - 1] + arr[mid]) / 2;
            };
            const medianX = median(xValues);
            const medianY = median(yValues);

            // Plugin to draw median lines
            const medianLinesPlugin = {
                id: 'medianLines',
                beforeDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;

                    ctx.save();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);

                    // Vertical line at median offense
                    const xPixel = xAxis.getPixelForValue(medianX);
                    ctx.beginPath();
                    ctx.moveTo(xPixel, yAxis.top);
                    ctx.lineTo(xPixel, yAxis.bottom);
                    ctx.stroke();

                    // Horizontal line at median defense
                    const yPixel = yAxis.getPixelForValue(medianY);
                    ctx.beginPath();
                    ctx.moveTo(xAxis.left, yPixel);
                    ctx.lineTo(xAxis.right, yPixel);
                    ctx.stroke();

                    // Add labels
                    ctx.setLineDash([]);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.fillText(`Med Off: ${medianX.toFixed(currentSport === 'nfl' ? 3 : 1)}`, xPixel + 5, yAxis.top + 15);
                    ctx.fillText(`Med Def: ${medianY.toFixed(currentSport === 'nfl' ? 3 : 1)}`, xAxis.left + 5, yPixel - 5);

                    ctx.restore();
                }
            };

            // Custom plugin to draw logos
            const logoPlugin = {
                id: 'logoPlugin',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0);
                    meta.data.forEach((point, index) => {
                        const d = dataPoints[index];
                        if (d) {
                            if (d.logo) {
                                const size = 40;
                                ctx.drawImage(d.logo, point.x - size/2, point.y - size/2, size, size);
                            } else {
                                // Fallback: draw colored dot based on rank
                                const size = 16;
                                ctx.beginPath();
                                ctx.arc(point.x, point.y, size/2, 0, 2 * Math.PI);
                                if (d.rank <= Math.ceil(dataPoints.length * 0.1)) {
                                    ctx.fillStyle = '#4ade80'; // Elite
                                } else if (d.rank <= Math.ceil(dataPoints.length * 0.25)) {
                                    ctx.fillStyle = '#667eea'; // Good
                                } else if (d.rank <= Math.ceil(dataPoints.length * 0.5)) {
                                    ctx.fillStyle = '#888'; // Average
                                } else {
                                    ctx.fillStyle = '#f87171'; // Below average
                                }
                                ctx.fill();
                            }
                        }
                    });
                }
            };

            efficiencyChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: dataPoints,
                        backgroundColor: 'transparent',
                        pointRadius: 20,
                        pointHoverRadius: 24
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.3,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = context.raw;
                                    return [
                                        `${d.team}`,
                                        `Rank: #${d.rank}`,
                                        `Rating: ${d.rating.toFixed(1)}`,
                                        `Off: ${d.x.toFixed(currentSport === 'nfl' ? 3 : 1)}`,
                                        `Def: ${d.y.toFixed(currentSport === 'nfl' ? 3 : 1)}`
                                    ];
                                }
                            },
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#333',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xLabel,
                                color: '#888'
                            },
                            grid: {
                                color: 'rgba(255, 100, 100, 0.3)'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yLabel,
                                color: '#888'
                            },
                            grid: {
                                color: 'rgba(255, 100, 100, 0.3)'
                            },
                            ticks: {
                                color: '#888'
                            },
                            reverse: true // Lower defense is better, so reverse the axis
                        }
                    }
                },
                plugins: [medianLinesPlugin, logoPlugin]
            });
        }

        // =============================================
        // TEAM HISTORY
        // =============================================

        async function loadAllSeasons() {
            if (allSeasonsCache[currentSport]) {
                return allSeasonsCache[currentSport];
            }

            const pathMap = { cbb: 'data/seasons.json', cfb: 'data/cfb/seasons.json', nfl: 'data/nfl/seasons.json' };
            const seasonResponse = await fetch(pathMap[currentSport]);
            const seasonData = await seasonResponse.json();
            const seasons = seasonData.seasons;

            const ratingPathMap = { cbb: 'data', cfb: 'data/cfb', nfl: 'data/nfl' };
            const basePath = ratingPathMap[currentSport];

            const results = await Promise.all(
                seasons.map(async (season) => {
                    try {
                        const resp = await fetch(`${basePath}/ratings_${season}.json`);
                        const data = await resp.json();
                        return { season, ratings: data.ratings };
                    } catch (e) {
                        console.warn(`Failed to load ${currentSport} season ${season}`, e);
                        return { season, ratings: [] };
                    }
                })
            );

            const cache = {};
            results.forEach(r => { cache[r.season] = r.ratings; });
            allSeasonsCache[currentSport] = cache;
            return cache;
        }

        function findTeamInSeason(ratings, teamName, teamId) {
            if (currentSport === 'cbb' && teamId) {
                const numId = parseInt(teamId);
                return ratings.find(r => r.teamId === numId);
            }
            // Exact match first
            let match = ratings.find(r => r.team === teamName);
            if (match) return match;

            // CFB: try alternate names via cfbTeamIds
            if (currentSport === 'cfb') {
                const espnId = cfbTeamIds[teamName];
                if (espnId) {
                    const altNames = Object.entries(cfbTeamIds)
                        .filter(([_, id]) => id === espnId)
                        .map(([name, _]) => name);
                    for (const alt of altNames) {
                        match = ratings.find(r => r.team === alt);
                        if (match) return match;
                    }
                }
            }
            return null;
        }

        function getTeamHistoryLogoUrl(teamName, teamId) {
            if (currentSport === 'nfl') {
                return `https://a.espncdn.com/i/teamlogos/nfl/500/${teamName.toLowerCase()}.png`;
            } else if (currentSport === 'cbb' && teamId) {
                return `https://a.espncdn.com/i/teamlogos/ncaa/500/${teamId}.png`;
            } else if (currentSport === 'cfb') {
                const espnId = cfbTeamIds[teamName];
                if (espnId) {
                    return `https://a.espncdn.com/i/teamlogos/ncaa/500/${espnId}.png`;
                }
            }
            return null;
        }

        function formatSeason(year) {
            if (currentSport === 'cbb') {
                return `${year - 1}-${String(year).slice(2)}`;
            } else {
                return `${year}-${String(year + 1).slice(2)}`;
            }
        }

        function closeModal() {
            document.getElementById('team-history-modal').classList.remove('visible');
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }
        }

        function renderHistoryChart(labels, ratings, ranks) {
            const ctx = document.getElementById('history-chart').getContext('2d');

            if (historyChart) {
                historyChart.destroy();
            }

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Rating',
                            data: ratings,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Rank',
                            data: ranks,
                            borderColor: '#4ade80',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#888' }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#333',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888', maxRotation: 45 },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Rating',
                                color: '#667eea'
                            },
                            ticks: { color: '#667eea' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            reverse: true,
                            title: {
                                display: true,
                                text: 'Rank',
                                color: '#4ade80'
                            },
                            ticks: { color: '#4ade80' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        async function showTeamHistory(teamName, teamId) {
            const modal = document.getElementById('team-history-modal');
            const content = document.getElementById('modal-content');

            content.innerHTML = '<div class="modal-loading">Loading team history...</div>';
            modal.classList.add('visible');

            try {
                const allSeasons = await loadAllSeasons();
                const history = [];

                const seasonYears = Object.keys(allSeasons).map(Number).sort((a, b) => a - b);
                for (const season of seasonYears) {
                    const ratings = allSeasons[season];
                    const team = findTeamInSeason(ratings, teamName, teamId);
                    if (team) {
                        history.push({
                            season,
                            rank: team.rank,
                            rating: team.rating,
                            record: team.record || '-',
                            adjO: team.adjO,
                            adjD: team.adjD,
                            adjOffEpa: team.adjOffEpa,
                            adjDefEpa: team.adjDefEpa,
                            totalTeams: ratings.length
                        });
                    }
                }

                if (history.length === 0) {
                    content.innerHTML = `
                        <div class="modal-header"><h2>${teamName}</h2></div>
                        <div class="modal-loading">No historical data found for this team.</div>
                    `;
                    return;
                }

                // Logo
                let logoHtml = '';
                const logoUrl = getTeamHistoryLogoUrl(teamName, teamId);
                if (logoUrl) {
                    logoHtml = `<img src="${logoUrl}" alt="${teamName}" onerror="this.style.display='none'">`;
                }

                // Summary stats
                const bestRating = Math.max(...history.map(h => h.rating));
                const bestRank = Math.min(...history.map(h => h.rank));
                const avgRating = (history.reduce((s, h) => s + h.rating, 0) / history.length);

                // Chart data
                const chartLabels = history.map(h => formatSeason(h.season));
                const chartRatings = history.map(h => h.rating);
                const chartRanks = history.map(h => h.rank);

                // Table (sport-specific columns)
                let tableHeaders, tableRows;

                if (currentSport === 'nfl') {
                    tableHeaders = '<th>Season</th><th>Rank</th><th>Rating</th><th>Record</th><th class="hide-mobile">Adj Off EPA</th><th class="hide-mobile">Adj Def EPA</th>';
                    tableRows = history.slice().reverse().map(h => `
                        <tr>
                            <td>${formatSeason(h.season)}</td>
                            <td class="rank">${h.rank}</td>
                            <td class="${h.rating >= 0 ? 'rating' : 'rating negative'}">${h.rating.toFixed(1)}</td>
                            <td class="number">${h.record}</td>
                            <td class="number hide-mobile">${h.adjOffEpa?.toFixed(3) || '-'}</td>
                            <td class="number hide-mobile">${h.adjDefEpa?.toFixed(3) || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tableHeaders = '<th>Season</th><th>Rank</th><th>Rating</th><th>Record</th><th class="hide-mobile">AdjO</th><th class="hide-mobile">AdjD</th>';
                    tableRows = history.slice().reverse().map(h => `
                        <tr>
                            <td>${formatSeason(h.season)}</td>
                            <td class="rank">${h.rank}</td>
                            <td class="${h.rating >= 0 ? 'rating' : 'rating negative'}">${h.rating.toFixed(2)}</td>
                            <td class="number">${h.record}</td>
                            <td class="number hide-mobile">${h.adjO?.toFixed(1) || '-'}</td>
                            <td class="number hide-mobile">${h.adjD?.toFixed(1) || '-'}</td>
                        </tr>
                    `).join('');
                }

                content.innerHTML = `
                    <div class="modal-header">
                        ${logoHtml}
                        <div>
                            <h2>${teamName}</h2>
                            <div class="team-meta">
                                ${history.length} seasons | Best rank: #${bestRank} | Best rating: ${bestRating.toFixed(1)} | Avg rating: ${avgRating.toFixed(1)}
                            </div>
                        </div>
                    </div>
                    <div class="history-chart-container">
                        <canvas id="history-chart"></canvas>
                    </div>
                    <table class="history-table">
                        <thead><tr>${tableHeaders}</tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                `;

                renderHistoryChart(chartLabels, chartRatings, chartRanks);

            } catch (e) {
                console.error('Error loading team history:', e);
                content.innerHTML = '<div class="modal-loading">Failed to load team history.</div>';
            }
        }

        // Event listeners
        document.getElementById('season').addEventListener('change', loadRatings);
        document.getElementById('search').addEventListener('input', filterRatings);
        document.getElementById('power-teams-only').addEventListener('change', () => {
            if (allRatings.length > 0) {
                renderEfficiencyChart(allRatings);
            }
        });

        // Modal close handlers
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('team-history-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('team-history-modal')) {
                closeModal();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Tab click handlers
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const sport = tab.dataset.sport;
                switchSport(sport);
            });
        });

        // Initial load
        loadSeasons().then(loadRatings);
    </script>
</body>
</html>
